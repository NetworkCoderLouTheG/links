<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Yuka's Builds</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @font-face {
            font-family: 'Cleanow';
            src: url('Cleanow.ttf') format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cleanow', sans-serif;
            background: #e0d6cd;
            color: #181818;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 16px;
            border-top: 5px solid #8f2f2f;
        }

        .card {
            margin: auto;
            position: relative;
            background: #ddd8d3;
            width: 100%;
            max-width: 800px;
            border-radius: 18px;
            padding: 26px 22px 30px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.16);
            display: flex;
            flex-direction: column;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: url("Images/sd_logo.png") center/140% no-repeat;
            opacity: 0.30;
            filter: blur(2px);
            z-index: 0;
            pointer-events: none;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: right;
        }

        .admin-badge {
            color: #8f2f2f;
            font-size: 0.8rem;
            border: 1px solid #8f2f2f;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 10px;
            text-transform: uppercase;
            vertical-align: middle;
        }

        .back-btn {
            text-decoration: none;
            color: #181818;
            font-weight: 600;
            border: 1px solid #181818;
            padding: 8px 14px;
            border-radius: 99px;
            transition: 0.2s;
        }

        .back-btn:hover {
            background: #181818;
            color: #f5ece4;
        }

        .builds-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media(min-width: 600px) {
            .builds-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .build-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .build-item:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.9);
        }

        .build-img-wrap {
            width: 100%;
            height: 180px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            margin-bottom: 10px;
        }

        .build-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-card {
            background: #f0e6dd;
            width: 95%;
            max-width: 500px;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(30px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-card {
            transform: translateY(0);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
        }

        /* --- FIXED EDITABLE IMAGE --- */
        .modal-img-wrap {
            width: 100%;
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            background: #000;
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            z-index: 2;
        }

        .modal-img-wrap:hover {
            border-color: #181818;
        }

        .modal-img-wrap::after {
            content: "Change Character";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .modal-img-wrap:hover::after {
            opacity: 1;
        }

        /* CSS class to disable hover effect for Survivor */
        .modal-img-wrap.no-hover {
            cursor: default;
            border-color: transparent !important;
        }
        .modal-img-wrap.no-hover::after {
            display: none !important;
        }

        .modal-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center;
        }

        /* ROBLOX INPUT STYLES */
        .roblox-input-container {
            display: none; /* Hidden by default */
            margin-bottom: 15px;
            gap: 5px;
            justify-content: center;
        }

        .roblox-input {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #aaa;
            background: rgba(255, 255, 255, 0.5);
            width: 60%;
            font-family: inherit;
        }

        .roblox-btn {
            padding: 8px 12px;
            background: #2f5f8f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
        }

        .roblox-btn:hover {
            background: #1f4f7f;
        }

        /* SLOT CONTAINER */
        .slots-wrapper {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px; 
            margin-bottom: 20px;
            position: relative;
            z-index: 5;
            align-items: center;
        }

        /* HEXAGON SLOT */
        .hex-slot {
            width: 70px;
            height: 70px;
            background: #2a2a2a;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid rgba(255, 255, 255, 0.1); 
            position: relative;
            overflow: hidden; /* Ensures scale doesn't spill out */
        }

        .hex-slot:hover {
            transform: scale(1.1);
            background: #3a3a3a;
        }

        .hex-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Scale up to maximize space inside the hexagon */
            transform: scale(1.95); 
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: none;
        }

        /* SQUARE ITEM SLOT */
        .item-slot {
            width: 70px;
            height: 70px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid rgba(255, 255, 255, 0.2);
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-left: 30px;
            overflow: hidden;
        }

        /* VERTICAL SEPARATOR LINE */
        .item-slot::before {
            content: "";
            position: absolute;
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 40px;
            background: rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .item-slot:hover {
            transform: scale(1.1);
            background: #3a3a3a;
            border-color: #8f2f2f;
        }

        .item-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            display: none;
            /* Scale up slightly to fit better */
            transform: scale(1);
        }

        /* PLUS SIGN FOR BOTH */
        .hex-slot::after, .item-slot::after {
            content: "+";
            color: #666;
            font-size: 2rem;
            font-weight: bold;
            position: absolute;
            pointer-events: none;
        }

        .hex-slot.filled::after, .item-slot.filled::after {
            display: none;
        }

        .hex-slot.filled img, .item-slot.filled img {
            display: block;
        }

        /* --- KILLER POWER SECTION --- */
        .killer-powers-wrapper {
            margin: 10px 0 20px 0;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 10px;
        }

        .power-entry {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 60px;
            height: 60px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .power-info {
            display: flex;
            flex-direction: column;
        }

        .power-info h4 {
            font-size: 1.1rem;
            color: #8f2f2f;
            margin-bottom: 2px;
        }

        .power-info p {
            font-size: 0.85rem;
            color: #4a4139;
            line-height: 1.2;
        }

        /* DETAILS LIST */
        .perk-details-list {
            margin-top: 10px;
            padding-top: 10px;
        }

        .perk-detail-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }
        
        .perk-detail-item.is-item {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 10px;
        }

        .perk-detail-item img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .perk-text h4 {
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .perk-text p {
            font-size: 0.85rem;
            color: #4a4139;
            line-height: 1.4;
        }

        /* SELECTOR MODAL */
        .selection-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            padding: 20px;
        }

        .selection-modal.open {
            display: flex;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            padding: 10px;
        }

        .selection-grid::-webkit-scrollbar {
            width: 8px;
        }
        .selection-grid::-webkit-scrollbar-thumb {
            background: #8f2f2f;
            border-radius: 4px;
        }

        .select-option {
            width: 100%;
            background: transparent;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .select-option:hover {
            transform: translateY(-2px);
        }

        .select-option img {
            width: 85px; 
            height: 85px;
            object-fit: cover;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            background: #2a2a2a;
            margin-bottom: 8px;
            transition: 0.2s;
            /* Scale up to maximize space inside the hexagon selector */
            transform: scale(1.25); 
        }
        
        .select-option:hover img {
            background: #3a3a3a;
            transform: scale(1.35);
        }
        
        .select-option p {
            font-size: 0.85rem;
            color: #ffffff;
            text-align: center;
            width: 100%;
            line-height: 1.2;
            font-weight: 600;
        }

        .selection-title {
            color: #fff;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .cancel-select {
            margin-top: 15px;
            color: #aaa;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
        }

        .remove-btn {
            margin-top: 20px;
            background: #8f2f2f;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: 0.2s;
            display: none;
        }

        .remove-btn:hover {
            background: #b83b3b;
        }
    </style>
</head>
<body>

    <div class="card">
        <div class="header-nav">
            <a href="viewer.html" class="back-btn" target="_blank">Test Viewer â†’</a>
            <div class="page-title"><span class="admin-badge">Admin</span> my vd builds</div>
        </div>

        <div class="builds-grid">
            <div class="build-item" onclick="openBuild('killer')">
                <div class="build-img-wrap">
                    <img id="grid-killer-img" src="Images/TheKiller.png">
                </div>
                <div class="build-info">
                    <h3 id="grid-killer-title">The Killer</h3>
                    <p style="color:#8f2f2f; font-weight:bold; margin-top:5px; font-size:0.9rem;">Edit Killer Loadout</p>
                </div>
            </div>

            <div class="build-item" onclick="openBuild('survivor')">
                <div class="build-img-wrap">
                    <img id="grid-survivor-img" src="Images/TheSurvivor.png" onerror="this.src='https://placehold.co/400x600/333/FFF?text=Survivor'">
                </div>
                <div class="build-info">
                    <h3 id="grid-survivor-title">The Survivor</h3>
                    <p style="color:#2f5f8f; font-weight:bold; margin-top:5px; font-size:0.9rem;">Edit Survivor Loadout</p>
                </div>
            </div>
        </div> 
    </div>

    <div id="buildModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-card">
            <span class="close-btn" onclick="toggleModal(false)">&times;</span>
            
            <div id="imageWrapper" class="modal-img-wrap" onclick="openSelector('character', null)">
                <img id="modalImg" src="" alt="Build Detail">
            </div>

            <div id="robloxInputContainer" class="roblox-input-container">
                <input type="text" id="robloxIdInput" class="roblox-input" placeholder="Enter Roblox User ID">
                <button class="roblox-btn" onclick="loadRobloxAvatar()">Load Avatar</button>
            </div>
            
            <div id="hexContainer" class="slots-wrapper"></div>
            
            <h2 id="modalTitle" style="font-size:1.5rem; margin-bottom:5px;">Title</h2>
            <p id="modalDesc" style="margin-bottom:10px; font-size:0.9rem;">Description</p>
            
            <div id="killerPowerSection" class="killer-powers-wrapper"></div>

            <div id="perkDetails" class="perk-details-list"></div>
            
            <div id="selectionMenu" class="selection-modal">
                <h3 id="selectionTitle" class="selection-title">Choose Item</h3>
                <div id="selectionGrid" class="selection-grid"></div>
                <button id="unequipBtn" class="remove-btn" onclick="removePerk()">Unequip Slot</button>
                <div class="cancel-select" onclick="closeSelector()">Cancel</div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAFyLfbWKoTcnY9tRdeR_JA8D6IxIDtgS8",
            authDomain: "yuka-website-database.firebaseapp.com",
            projectId: "yuka-website-database",
            storageBucket: "yuka-website-database.firebasestorage.app",
            messagingSenderId: "560430723404",
            appId: "1:560430723404:web:8cb5e238a4ffc38c831fe9",
            measurementId: "G-7KW8R01QX1"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- LIBRARIES ---

        const killerLibrary = [
            { 
                id: 'slasher', 
                name: 'The Slasher', 
                img: 'Images/Killers/TheSlasher.png', 
                desc: 'A relentless force, The Slasher moves undetected.',
                powers: [
                    { name: "Lake Mist", img: "Images/KillerSkills/LakeMist.png", desc: "Embrace the power of the lake and vanish into the mist. Activate Lake Mist when no one is nearby or watching to become undetectable." },
                    { name: "Pursuit", img: "Images/KillerSkills/Pursuit.png", desc: "Unleash your fury, gaining increased movement speed for 20 seconds during which you can walk trough obstacles." } 
                ]       
            },
            { 
                id: 'stalker', 
                name: 'The Stalker', 
                img: 'Images/Killers/TheStalker.png', 
                desc: 'A Masked sadistic individual obsessed with survivors.',
                powers: [
                    { name: "Stalk", img: "Images/KillerSkills/Stalk.png", desc: "The Stalker's progression reflects his twisted obsession, growing more dangerous and insidious as he observes his prey." },
                    { name: "Evil's Grasp", img: "Images/KillerSkills/Evil'sGrasp.png", desc: "The stalker raises his arm, lunging forward to grab a survivor. On contact, he slams them into the ground, applying Anti-Heal for 40 seconds." } 
                ]
            },
            { 
                id: 'killer', 
                name: 'The Killer', 
                img: 'Images/Killers/TheKiller.png', 
                desc: 'An amateur killer inspired by the urban legend.',
                powers: [
                    { name: "Frenzy", img: "Images/KillerSkills/Frenzy.png", desc: "Upon activation grants The Killer the Frenzy Buff, granting him various abilities such as being able to vault pallets, able to chain hits to gain movement speed and being able to track Survivors near your Killer instinct." }
                ]
            },
            { 
                id: 'hidden', 
                name: 'The Hidden', 
                img: 'Images/Killers/TheHidden.png', 
                desc: 'Many test subjects were rendered insane.',
                powers: [
                    { name: "Mark", img: "Images/KillerSkills/Mark.png", desc: "Change your knife stance and lunge forward marking any survivor hit for 10 seconds to initiate the hunt." },
                    { name: "Leap", img: "Images/KillerSkills/Leap.png", desc: "Launch yourself in the direction you're looking at jumping over obstacles and everything in your way." } 
                ]
            },
            { 
                id: 'masked', 
                name: 'The Masked', 
                img: 'Images/Killers/TheMasked.png', 
                desc: 'Attempts to gain the attention of 50 Blessings.',
                powers: [
                    { name: "Mask Up", img: "Images/KillerSkills/MaskUp.png", desc: "Grants The Masked the ability to swap to a random mask every 30 seconds for a full minute upon activation. Every mask is characterized by a unique skill that displays when switching masks, and some even altering the playstyle." }
                ]
            },
            { 
                id: 'abysswalker', 
                name: 'The Abysswalker', 
                img: 'Images/Killers/TheAbysswalker.png', 
                desc: 'Once a great knight to a king, now consumed by the abyss.',
                powers: [
                    { name: "Dark Severance", img: "Images/KillerSkills/DarkSeverance.png", desc: "The Abysswalker charges up a horizontal slash THAT CAN BE DODGED BY CROUCHING and gains movement speed during build up to unleash an attack that deals damage to more than one survivor." },
                    { name: "Abyssal Burst", img: "Images/KillerSkills/AbyssalBurst.png", desc: "The Abysswalker swings his hand for a long windup and sends out a burst of corruption that travels the whole map, Survivors hit are highlighted for the killer and are slowed by 50% for 7 seconds." } 
                ]
            },
            { 
                id: 'veil', 
                name: 'The Veil', 
                img: 'Images/Killers/TheVeil.png', 
                desc: 'Her spirit lingers, pierced by spears.',
                powers: [
                    { name: "Pierced Vow", img: "Images/KillerSkills/PiercedVow.png", desc: "The Veil switches from her dagger to the spears lodged on her body." },
                    { name: "Through the Veil", img: "Images/KillerSkills/ThroughTheVeil.png", desc: "After charging a spear for up to two seconds, the Veil transfers it to the other world, allowing it to ignore collisions and pass through walls." } 
                ]
            },
        ];

        const survivorLibrary = [
            { id: 'yuka', name: 'Yuka', img: 'Images/Survivor_Yuka.png', desc: 'Resourceful and determined.' },
            { id: 'lou', name: 'lou', img: 'Images/lou.png', desc: 'A nervous leader.' },
        ];

        const killerPerkLibrary = [
            { id: 'terror', name: 'Terror Spread', img: 'Images/KillerPerks/TerrorSpreadIcon.png', desc: 'Survivors suffer Winded status after repairing.' },
            { id: 'piercing', name: 'Piercing Reverie', img: 'Images/KillerPerks/PiercingReverieIcon.png', desc: 'Gain tokens to pause and regress generators.' },
            { id: 'sloppy', name: 'Sloppy Mess', img: 'Images/KillerPerks/SloppyMessIcon.png', desc: 'Bleed more, heal slower.' },
            { id: 'echo', name: 'Echo Of The Void', img: 'Images/KillerPerks/EchoOftheVoidIcon.png', desc: 'Loud noise notification on Line of Sight.' },
            { id: 'abyssal', name: 'Abyssal Covenant', img: 'Images/KillerPerks/AbyssalCovenantIcon.png', desc: 'Chance for generator to break at 50%.' },
            { id: 'blood', name: 'Blood Between Worlds', img: 'Images/KillerPerks/BloodBetweenWorldsIcon.png', desc: 'Damage survivor to regress random generator.' },
            { id: 'brutal', name: 'Brutal Strength', img: 'Images/KillerPerks/BrutalStrengthIcon.png', desc: 'Break pallets and gens faster.' },
            { id: 'combo', name: 'Combo Streak', img: 'Images/KillerPerks/ComboStreakIcon.png', desc: 'Speed boost after basic attack.' },
            { id: 'corrupted', name: 'Corrupted Path', img: 'Images/KillerPerks/CorruptedPathIcon.png', desc: 'Spread corruption trails.' },
            { id: 'crack', name: 'Crackdown', img: 'Images/KillerPerks/CrackdownIcon.png', desc: 'Increase gen damage.' },
            { id: 'location', name: 'Echo Location', img: 'Images/KillerPerks/EchoLocationIcon.png', desc: 'Reveal survivors after breaking gen.' },
            { id: 'enhanced', name: 'Enhanced Senses', img: 'Images/KillerPerks/EnhancedSensesIcon.png', desc: 'See aura on rushed actions.' },
            { id: 'eternal', name: 'Eternal Torment', img: 'Images/KillerPerks/EternalTormentIcon.png', desc: 'Survivors become vulnerable after stunning you.' },
            { id: 'excitement', name: 'Excitement', img: 'Images/KillerPerks/ExcitementIcon.png', desc: 'Speed boost but increased terror radius.' },
            { id: 'hard', name: 'Hard Swing', img: 'Images/KillerPerks/HardSwingIcon.png', desc: 'Apply Winded status on hit.' },
            { id: 'next', name: 'Next In Line', img: 'Images/KillerPerks/NextInLineIcon.png', desc: 'Reveal farthest survivor on down.' },
            { id: 'offscreen', name: 'Offscreen Scare', img: 'Images/KillerPerks/OffscreenScareIcon.png', desc: 'Speed boost when not in chase.' },
            { id: 'play', name: 'Play With Your Food', img: 'Images/KillerPerks/PlayWithYourFoodIcon.png', desc: 'Gain tokens for speed by letting obsession escape.' },
            { id: 'predator', name: 'Predator', img: 'Images/KillerPerks/PredatorIcon.png', desc: 'See aura if survivor escapes chase.' },
            { id: 'resentment', name: 'Resentment Clinger', img: 'Images/KillerPerks/ResentmentClingerIcon.png', desc: 'Lunge increase based on tokens.' },
            { id: 'shadow', name: 'Shadow Trace', img: 'Images/KillerPerks/ShadowTraceIcon.png', desc: 'Hide intent radius at start.' }
        ];

        const survivorPerkLibrary = [
            { id: 'born', name: 'Born In Blood', img: 'Images/SurvivorPerks/BornInBloodIcon.png', desc: 'Heal speed boost.' },
            { id: 'call', name: 'Call Me Back', img: 'Images/SurvivorPerks/CallMeBackIcon.png', desc: 'See aura after heal hit.' },
            { id: 'desperate', name: 'Desperate', img: 'Images/SurvivorPerks/DesperateIcon.png', desc: 'Instant wiggle progress.' },
            { id: 'enhancedtouch', name: 'Enchanced Touch', img: 'Images/SurvivorPerks/EnchancedTouchIcon.png', desc: 'Heal gives buffs.' },
            { id: 'expensive', name: 'Expensive Decor', img: 'Images/SurvivorPerks/ExpensiveDecorIcon.png', desc: 'Healing boost decays.' },
            { id: 'flow', name: 'Flowstate', img: 'Images/SurvivorPerks/FlowStateIcon.png', desc: 'Fast vault speed boost.' },
            { id: 'grab', name: 'Grab My Hand', img: 'Images/SurvivorPerks/GrabMyHand.png', desc: 'Unhook fills healing bar.' },
            { id: 'collapse', name: 'Great Collapse', img: 'Images/SurvivorPerks/GreatCollapseIcon.png', desc: 'Speed boost on stun.' },
            { id: 'group', name: 'Group Project', img: 'Images/SurvivorPerks/GroupProject.png', desc: 'Co-op repair speed.' },
            { id: 'heads', name: 'Heads Up', img: 'Images/SurvivorPerks/HeadsUpIcon.png', desc: 'Killer proximity warning.' },
            { id: 'karma', name: 'High Karma', img: 'Images/SurvivorPerks/HighKarma.png', desc: 'Self unhook but anti-heal.' },
            { id: 'workout', name: 'Intense Workout', img: 'Images/SurvivorPerks/IntenseWorkoutIcon.png', desc: 'Faster save speed.' },
            { id: 'tranquility', name: 'Iron Tranquility', img: 'Images/SurvivorPerks/IronTranquilityIcon.png', desc: 'Hidden aura when spiked.' },
            { id: 'laststand', name: 'Last Stand', img: 'Images/SurvivorPerks/LastStandIcon.png', desc: 'Heal when last alive.' },
            { id: 'leftbehind', name: 'Left Behind', img: 'Images/SurvivorPerks/LeftBehind.png', desc: 'Speed boost when teammate escapes.' },
            { id: 'nobody', name: 'Nobody Left Behind', img: 'Images/SurvivorPerks/NobodyLeftBehindIcon.png', desc: 'Endgame heal boost.' },
            { id: 'own', name: 'On My Own', img: 'Images/SurvivorPerks/OnMyOwn.png', desc: 'Open gates faster alone.' },
            { id: 'pacifist', name: 'Pacifist', img: 'Images/SurvivorPerks/Pacifist.png', desc: 'Heal up, repair down.' },
            { id: 'landing', name: 'Perfect Landing', img: 'Images/SurvivorPerks/PerfectLandingIcon.png', desc: 'Fall recovery speed.' },
            { id: 'second', name: 'Second Wind', img: 'Images/SurvivorPerks/SecondWindIcon.png', desc: 'Invincibility after save.' },
            { id: 'snake', name: 'Snake Step', img: 'Images/SurvivorPerks/SnakeStepIcon.png', desc: 'Crouch speed boost.' },
            { id: 'grow', name: 'Time To Grow Up', img: 'Images/SurvivorPerks/TimeToGrowUpIcon.png', desc: 'Extended hit boost.' },
            { id: 'stronger', name: 'We Are Stronger Together', img: 'Images/SurvivorPerks/We\'reStrongerTogether.png', desc: 'Proximity speed boost.' }
        ];

        const survivorItemLibrary = [
            { id: 'adrenaline', name: 'Adrenaline Shot', img: 'Images/Items/AdrenalineShot.png', desc: 'Allows self-healing or faster healing of others.' },
            { id: 'bandage', name: 'Bandage', img: 'Images/Items/Bandage.png', desc: 'Can blind the killer or burn wraith.' },
            { id: 'flashlight', name: 'Flashlight', img: 'Images/Items/Flashlight.png', desc: 'Increases repair speed or sabotage hooks.' },
            { id: 'gate', name: 'Gate', img: 'Images/Items/Gate.png', desc: 'Tracks objects in the world.' },
            { id: 'motion', name: 'Motion Tracker', img: 'Images/Items/MotionTracker.png', desc: 'Can open the hatch or read auras.' },
            { id: 'dagger', name: 'Parrying Dagger', img: 'Images/Items/ParryingDagger.png', desc: 'Can open the hatch or read auras.' },
            { id: 'clone', name: 'Shadow Clone', img: 'Images/Items/ShadowClone.png', desc: 'Can open the hatch or read auras.' },
            { id: 'fate', name: 'Twist of Fate', img: 'Images/Items/TwistOfFate.png', desc: 'Can open the hatch or read auras.' }
        ];

        // --- STATE MANAGEMENT ---

        let editMode = 'killer'; 
        
        let killerBuild = {
            character: killerLibrary[0],
            perks: [null, null, null] 
        };

        let survivorBuild = {
            character: { name: "Survivor", img: "Images/TheSurvivor.png", desc: "A survivor trying to escape." }, // Default Fallback
            perks: [null, null, null], 
            item: null,
            robloxId: "" 
        };

        let activeSlotIndex = null; 


        // --- FIRESTORE LISTENERS ---

        db.collection("builds").doc("mainBuild").onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                
                if(data.killerBuild) killerBuild = data.killerBuild;

                if(data.survivorBuild) {
                    survivorBuild = data.survivorBuild;
                    if(survivorBuild.perks.length === 4) {
                        survivorBuild.perks.pop(); 
                        survivorBuild.item = null; 
                    }
                }

                initGridUI();
                
                if(document.getElementById('buildModal').classList.contains('active')) {
                    updateModalUI();
                }
            } else {
                console.log("Creating initial database entry...");
                saveData(); 
            }
        }, (error) => {
            console.error("Error reading DB:", error);
        });

        function saveData() {
            db.collection("builds").doc("mainBuild").set({
                killerBuild: killerBuild,
                survivorBuild: survivorBuild
            }, { merge: true })
            .then(() => { console.log("Saved to cloud"); })
            .catch((error) => { alert("Error saving: " + error); });
        }


        function initGridUI() {
            const kImg = document.getElementById('grid-killer-img');
            const kTitle = document.getElementById('grid-killer-title');
            if(kImg && killerBuild.character.img) kImg.src = killerBuild.character.img;
            if(kTitle) kTitle.innerText = killerBuild.character.name;

            const sImg = document.getElementById('grid-survivor-img');
            const sTitle = document.getElementById('grid-survivor-title');
            if(sTitle) sTitle.innerText = survivorBuild.character.name || "Survivor";

            // UPDATED ROBLOX LOGIC
            if (survivorBuild.robloxId) {
                sImg.src = `https://www.roblox.com/avatar-thumbnail/image?userId=${survivorBuild.robloxId}&width=420&height=420&format=png`;
            } else {
                // Fallback to default image if no ID
                sImg.src = "Images/TheSurvivor.png";
            }
        }

        function openBuild(mode) {
            editMode = mode;
            generateSlots(); 
            updateModalUI();
            toggleModal(true);
        }

        function generateSlots() {
            const container = document.getElementById('hexContainer');
            container.innerHTML = ''; 
            
            const perks = (editMode === 'killer') ? killerBuild.perks : survivorBuild.perks;
            
            perks.forEach((_, index) => {
                const div = document.createElement('div');
                div.className = 'hex-slot';
                div.onclick = () => openSelector('perk', index);
                div.innerHTML = `<img id="slot-${index}-img" src="">`;
                container.appendChild(div);
            });

            if (editMode === 'survivor') {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-slot'; 
                itemDiv.onclick = () => openSelector('item', null);
                itemDiv.innerHTML = `<img id="slot-item-img" src="">`;
                container.appendChild(itemDiv);
            }
        }

        function updateModalUI() {
            const currentBuild = (editMode === 'killer') ? killerBuild : survivorBuild;
            const modalImg = document.getElementById('modalImg');
            const robloxInputDiv = document.getElementById('robloxInputContainer');
            const imgWrapper = document.getElementById('imageWrapper');

            // 1. Killer Logic
            if (editMode === 'killer') {
                document.getElementById('modalTitle').innerText = currentBuild.character.name;
                document.getElementById('modalDesc').innerText = currentBuild.character.desc;
                
                modalImg.src = currentBuild.character.img;
                
                // Show power section
                const powerSection = document.getElementById('killerPowerSection');
                powerSection.innerHTML = ''; 
                if (currentBuild.character.powers && currentBuild.character.powers.length > 0) {
                    powerSection.style.display = 'flex';
                    currentBuild.character.powers.forEach(power => {
                        const powerDiv = document.createElement('div');
                        powerDiv.className = 'power-entry';
                        powerDiv.innerHTML = `
                            <img class="power-icon" src="${power.img}">
                            <div class="power-info">
                                <h4>${power.name}</h4>
                                <p>${power.desc}</p>
                            </div>
                        `;
                        powerSection.appendChild(powerDiv);
                    });
                } else {
                    powerSection.style.display = 'none';
                }

                // Hide input, Enable hover effect
                robloxInputDiv.style.display = 'none';
                imgWrapper.classList.remove('no-hover');
            } 
            
            // 2. Survivor Logic
            else {
                document.getElementById('modalTitle').innerText = "The Survivor";
                document.getElementById('modalDesc').innerText = "A survivor trying to escape.";
                
                // Hide power section
                document.getElementById('killerPowerSection').style.display = 'none';

                // Show Input, Disable hover effect
                robloxInputDiv.style.display = 'flex';
                imgWrapper.classList.add('no-hover');
                
                document.getElementById('robloxIdInput').value = survivorBuild.robloxId || "";

                if (survivorBuild.robloxId) {
                    modalImg.src = `https://www.roblox.com/avatar-thumbnail/image?userId=${survivorBuild.robloxId}&width=420&height=420&format=png`;
                } else {
                    modalImg.src = "Images/TheSurvivor.png";
                }
            }

            // 3. Render Perks (Common)
            const detailsContainer = document.getElementById('perkDetails');
            detailsContainer.innerHTML = ''; 
            
            currentBuild.perks.forEach((perk, index) => {
                const slotImg = document.getElementById(`slot-${index}-img`);
                if(!slotImg) return; 
                
                const slotDiv = slotImg.parentElement;
                
                if (perk) {
                    slotImg.src = perk.img; 
                    slotDiv.classList.add('filled');
                    detailsContainer.insertAdjacentHTML('beforeend', `
                        <div class="perk-detail-item">
                            <img src="${perk.img}">
                            <div class="perk-text">
                                <h4>${perk.name}</h4>
                                <p>${perk.desc}</p>
                            </div>
                        </div>
                    `);
                } else {
                    slotImg.src = ""; 
                    slotDiv.classList.remove('filled');
                }
            });

            if (editMode === 'survivor') {
                const itemImg = document.getElementById('slot-item-img');
                const itemDiv = itemImg.parentElement;
                const item = survivorBuild.item;

                if (item) {
                    itemImg.src = item.img;
                    itemDiv.classList.add('filled');
                    detailsContainer.insertAdjacentHTML('beforeend', `
                        <div class="perk-detail-item is-item">
                            <img src="${item.img}">
                            <div class="perk-text">
                                <h4 style="color:#2f5f8f;">ITEM: ${item.name}</h4>
                                <p>${item.desc}</p>
                            </div>
                        </div>
                    `);
                } else {
                    itemImg.src = "";
                    itemDiv.classList.remove('filled');
                }
            }
        }

        // --- NEW FUNCTION: SAVE ROBLOX ID ---
        function loadRobloxAvatar() {
            const inputVal = document.getElementById('robloxIdInput').value.trim();
            survivorBuild.robloxId = inputVal;
            
            // Just trigger a UI update and Save
            updateModalUI();
            saveData();
            
            // Also update the background grid immediately
            initGridUI();
        }

        function openSelector(type, index) {
            // STOP selector from opening if we clicked the survivor character image
            if (type === 'character' && editMode === 'survivor') {
                return;
            }

            activeSlotIndex = index; 
            
            const grid = document.getElementById('selectionGrid');
            const title = document.getElementById('selectionTitle');
            const unequipBtn = document.getElementById('unequipBtn');
            
            grid.innerHTML = ''; 
            let libraryToUse;
            let currentSelection = null;

            if (type === 'character') {
                title.innerText = "Choose Character";
                libraryToUse = killerLibrary; // Only killers use character selector now
                unequipBtn.style.display = 'none';
            } 
            else if (type === 'item') {
                title.innerText = "Choose Item";
                libraryToUse = survivorItemLibrary;
                currentSelection = survivorBuild.item;
                unequipBtn.style.display = (currentSelection !== null) ? 'block' : 'none';
            }
            else { 
                title.innerText = "Choose Perk";
                libraryToUse = (editMode === 'killer') ? killerPerkLibrary : survivorPerkLibrary;
                const currentPerks = (editMode === 'killer') ? killerBuild.perks : survivorBuild.perks;
                currentSelection = currentPerks[activeSlotIndex];
                unequipBtn.style.display = (currentSelection !== null) ? 'block' : 'none';
            }
            
            libraryToUse.forEach(item => {
                const div = document.createElement('div'); 
                div.className = 'select-option';
                div.onclick = () => selectItem(type, item);
                div.innerHTML = `
                    <img src="${item.img}">
                    <p>${item.name}</p>
                `;
                grid.appendChild(div);
            });
            
            document.getElementById('selectionMenu').classList.add('open');
        }

        function selectItem(type, itemObj) {
            if (editMode === 'killer') {
                if(type === 'character') killerBuild.character = itemObj;
                else killerBuild.perks[activeSlotIndex] = itemObj;
            } else {
                // Survivor character selection removed; inputs handled via Roblox ID
                if (type === 'item') survivorBuild.item = itemObj;
                else survivorBuild.perks[activeSlotIndex] = itemObj;
            }

            if(type === 'character') {
                updateModalUI();
                initGridUI(); 
            }

            saveData(); 
            updateModalUI(); 
            closeSelector();
        }

        function removePerk() {
            const title = document.getElementById('selectionTitle').innerText;

            if (editMode === 'killer') {
                killerBuild.perks[activeSlotIndex] = null;
            } else {
                if (title === "Choose Item") {
                    survivorBuild.item = null;
                } else {
                    survivorBuild.perks[activeSlotIndex] = null;
                }
            }
            updateModalUI(); 
            saveData();
            closeSelector();
        }

        function closeSelector() { document.getElementById('selectionMenu').classList.remove('open'); }
        function closeModal(event) { if (event.target.classList.contains('modal-overlay')) toggleModal(false); }
        function toggleModal(show) { const modal = document.getElementById('buildModal'); show ? modal.classList.add('active') : modal.classList.remove('active'); }
    </script>
</body>
</html>